<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>JEE Progress Tracker</title>
  <style>
    :root {
      --bg: #1e293b;
      --card-bg: #0f172a;
      --text: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent: #4facfe;
      --accent-hover: #3182ce;
      --border: #334155;
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
      --header-gradient: linear-gradient(90deg, #4facfe, #00f2fe);
      --danger: #ef4444;
      --danger-hover: #dc2626;
    }

    [data-theme="light"] {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --text: #1a202c;
      --text-secondary: #4a5568;
      --border: #e2e8f0;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --header-gradient: linear-gradient(90deg, #4facfe, #00f2fe);
      --danger: #ef4444;
      --danger-hover: #dc2626;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding-bottom: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    header {
      padding: 16px 20px;
      background: var(--header-gradient);
      color: white;
      font-size: 20px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .user-info {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .theme-toggle, .global-reset, .sync-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: white;
      font-weight: 500;
      transition: background 0.3s, transform 0.2s;
      white-space: nowrap;
    }

    .theme-toggle:hover, .global-reset:hover, .sync-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .theme-toggle:active, .global-reset:active, .sync-btn:active {
      transform: translateY(0);
    }

    .sync-btn.syncing {
      opacity: 0.6;
      pointer-events: none;
    }

    .dashboard {
      padding: 20px;
      background: var(--card-bg);
      border-radius: 16px;
      margin: 16px 16px 20px;
      box-shadow: var(--shadow);
    }

    .dashboard h3 {
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--text);
    }

    canvas {
      max-width: 100%;
      height: 200px;
      display: block;
      margin: 0 auto;
      background: transparent;
      border-radius: 8px;
    }

    .subjects-container {
      padding: 0 16px;
    }

    .subject {
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .subject-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .subject-header:hover {
      background: rgba(79, 172, 254, 0.05);
    }

    .subject-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .subject-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .reset-btn {
      background: var(--danger);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.3s, transform 0.2s;
    }

    .reset-btn:hover {
      background: var(--danger-hover);
      transform: translateY(-2px);
    }

    .reset-btn:active {
      transform: translateY(0);
    }

    .subject-toggle {
      width: 26px;
      height: 26px;
      background: var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      font-size: 14px;
      transition: transform 0.3s, background 0.2s;
      flex-shrink: 0;
    }

    .subject-toggle:hover {
      background: var(--accent);
    }

    .subject[data-expanded="false"] .subject-toggle {
      transform: rotate(0deg);
    }

    .subject[data-expanded="true"] .subject-toggle {
      transform: rotate(180deg);
    }

    .subject-content {
      padding: 0 16px 16px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-in-out;
    }

    .subject[data-expanded="true"] .subject-content {
      max-height: 2000px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    th, td {
      padding: 12px 6px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      min-width: 52px;
      width: 52px;
      vertical-align: middle;
    }
    
    th:first-child, td:first-child {
      width: auto;
      min-width: 160px;
    }

    thead th {
      background: rgba(79, 172, 254, 0.1);
      color: var(--text);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th:first-child, td:first-child {
      text-align: left;
      padding-left: 12px;
      font-weight: 500;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: rgba(79, 172, 254, 0.08);
    }

    input[type="checkbox"] {
      width: 22px;
      height: 22px;
      accent-color: var(--accent);
      cursor: pointer;
      transform: scale(1.05);
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    input[type="checkbox"]:hover {
      transform: scale(1.15);
    }

    .pyq-header {
      background: rgba(79, 172, 254, 0.15);
    }

    .pyq-label {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 4px 6px !important;
      font-weight: 500;
    }

    thead tr:nth-child(2) th {
      padding: 4px 6px;
      font-size: 11px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
      padding: 16px;
      margin: 16px;
      border-radius: 8px;
      text-align: center;
    }

    /* Mobile tweaks */
    @media (max-width: 480px) {
      header {
        flex-direction: column;
        gap: 12px;
        padding: 14px 12px;
        text-align: center;
      }
      .header-actions {
        flex-wrap: wrap;
        justify-content: center;
      }
      .theme-toggle, .global-reset, .sync-btn {
        padding: 6px 12px;
        font-size: 13px;
      }
      .subject-header {
        padding: 12px;
      }
      .subject-header h2 {
        font-size: 16px;
      }
      .reset-btn {
        padding: 5px 10px;
        font-size: 12px;
      }
      .subject-actions {
        gap: 8px;
      }
      th, td {
        padding: 10px 5px;
        font-size: 13px;
      }
      th:first-child, td:first-child {
        min-width: 130px;
      }
      canvas {
        height: 180px;
      }
      .subject-toggle {
        width: 24px;
        height: 24px;
        font-size: 12px;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">Loading...</div>
  <div id="app" style="display: none;">
    <header>
      <div>
        <div>JEE Preparation Dashboard</div>
        <div class="user-info" id="userInfo"></div>
      </div>
      <div class="header-actions">
        <button class="sync-btn" id="syncBtn" aria-label="Sync with cloud">‚òÅÔ∏è Sync</button>
        <button class="global-reset" id="globalReset" aria-label="Reset all progress">üîÑ Reset</button>
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark/light mode">üåô Theme</button>
      </div>
    </header>

    <div class="dashboard">
      <h3>Overall Progress</h3>
      <canvas id="progressChart" height="200"></canvas>
    </div>

    <div class="subjects-container" id="subjects"></div>
  </div>

  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ========================================
       CONFIGURATION - REPLACE THESE VALUES
       ======================================== */
    
    const SUPABASE_URL = 'https://felxtbxllluwwkiwcwzt.supabase.co';  // Replace with your Supabase project URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlbHh0YnhsbGx1d3draXdjd3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODQ3NTAsImV4cCI6MjA4NTg2MDc1MH0.9kCcyPC9_jqjAkOf6TYgoFG76Ymx9fjGzgAkmlvBPkg';  // Replace with your anon public key
    
    /* ======================================== */

    // Initialize Supabase
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Initialize Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // Get Telegram user data
    const telegramUser = tg.initDataUnsafe?.user;
    const telegramUserId = telegramUser?.id || 'demo_user'; // Fallback for testing
    const userName = telegramUser?.first_name || 'Demo User';

    // Display user info
    document.getElementById('userInfo').textContent = `üëã Hi, ${userName}!`;

    /* --------- SYLLABUS --------- */
    const syllabus = {
      Physics: [
        "Physics and Measurement", "Kinematics", "Laws of Motion", "Work, Energy and Power",
        "Rotational Motion", "Gravitation", "Properties of Solids and Liquids", "Thermodynamics",
        "Kinetic Theory of Gases", "Oscillations and Waves", "Electrostatics", "Current Electricity",
        "Magnetic Effects of Current and Magnetism", "Electromagnetic Induction and Alternating Currents",
        "Electromagnetic Waves", "Optics", "Dual Nature of Matter and Radiation", "Atoms and Nuclei",
        "Electronic Devices", "Communication Systems"
      ],
      Chemistry: [
        "Some Basic Concepts in Chemistry", "States of Matter", "Atomic Structure", "Chemical Bonding and Molecular Structure",
        "Chemical Thermodynamics", "Solutions", "Equilibrium", "Redox Reactions and Electrochemistry",
        "Chemical Kinetics", "Surface Chemistry", "Classification of Elements and Periodicity",
        "General Principles and Processes of Isolation of Metals", "Hydrogen", "s-Block Elements",
        "p-Block Elements", "d- and f-Block Elements", "Coordination Compounds", "Environmental Chemistry",
        "Purification and Characterisation of Organic Compounds", "Some Basic Principles of Organic Chemistry",
        "Hydrocarbons", "Organic Compounds Containing Halogens", "Organic Compounds Containing Oxygen",
        "Organic Compounds Containing Nitrogen", "Polymers", "Biomolecules", "Chemistry in Everyday Life",
        "Principles Related to Practical Chemistry"
      ],
      Mathematics: [
        "Sets, Relations and Functions", "Complex Numbers and Quadratic Equations", "Matrices and Determinants",
        "Permutations and Combinations", "Mathematical Induction", "Binomial Theorem", "Sequences and Series",
        "Limit, Continuity and Differentiability", "Integral Calculus", "Differential Equations",
        "Coordinate Geometry", "Three Dimensional Geometry", "Vector Algebra", "Statistics and Probability",
        "Trigonometry"
      ]
    };

    const COLUMNS = [
      "lecture", "revision",
      "pyq21", "pyq22", "pyq23", "pyq24", "pyq25", "pyq26",
      "formula"
    ];

    let data = {};
    let isSyncing = false;

    // Theme init
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.body.setAttribute("data-theme", savedTheme);
    updateThemeButton(savedTheme);

    function updateThemeButton(theme) {
      const btn = document.getElementById("themeToggle");
      btn.textContent = theme === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
    }

    /* --------- CLOUD STORAGE --------- */
    async function loadFromCloud() {
      try {
        const { data: userData, error } = await supabase
          .from('user_progress')
          .select('data')
          .eq('user_id', telegramUserId)
          .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
          throw error;
        }

        if (userData && userData.data) {
          data = userData.data;
          console.log('‚úÖ Data loaded from cloud');
        } else {
          // Initialize empty data for new user
          data = {};
          Object.keys(syllabus).forEach(subject => {
            data[subject] = {};
            syllabus[subject].forEach(chapter => {
              data[subject][chapter] = {};
              COLUMNS.forEach(col => {
                data[subject][chapter][col] = false;
              });
            });
          });
          console.log('‚úÖ Initialized new user data');
        }
        return true;
      } catch (error) {
        console.error('‚ùå Error loading from cloud:', error);
        showError('Failed to load data from cloud. Using local data.');
        return false;
      }
    }

    async function saveToCloud() {
      if (isSyncing) return;
      
      isSyncing = true;
      const syncBtn = document.getElementById('syncBtn');
      syncBtn.classList.add('syncing');
      syncBtn.textContent = '‚è≥ Syncing...';

      try {
        const { error } = await supabase
          .from('user_progress')
          .upsert({
            user_id: telegramUserId,
            data: data,
            updated_at: new Date().toISOString()
          });

        if (error) throw error;

        console.log('‚úÖ Data saved to cloud');
        syncBtn.textContent = '‚úÖ Synced!';
        setTimeout(() => {
          syncBtn.textContent = '‚òÅÔ∏è Sync';
          syncBtn.classList.remove('syncing');
        }, 2000);
      } catch (error) {
        console.error('‚ùå Error saving to cloud:', error);
        syncBtn.textContent = '‚ùå Failed';
        setTimeout(() => {
          syncBtn.textContent = '‚òÅÔ∏è Sync';
          syncBtn.classList.remove('syncing');
        }, 2000);
      } finally {
        isSyncing = false;
      }
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      document.getElementById('app').insertBefore(errorDiv, document.getElementById('app').firstChild);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    /* --------- INIT --------- */
    async function init() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('app').style.display = 'none';

      // Load data from cloud
      await loadFromCloud();

      // Render UI
      const root = document.getElementById("subjects");
      root.innerHTML = "";
      for (let subject in syllabus) {
        root.appendChild(renderSubject(subject));
      }
      drawGraph();

      // Restore expanded state
      Object.keys(syllabus).forEach(s => {
        const isExpanded = localStorage.getItem(`subject-${s}-expanded`) === "true";
        const el = document.querySelector(`.subject[data-subject="${s}"]`);
        if (el) el.setAttribute("data-expanded", String(isExpanded));
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    }

    function renderSubject(subject) {
      const div = document.createElement("div");
      div.className = "subject";
      div.setAttribute("data-subject", subject);
      div.setAttribute("data-expanded", "false");
      div.innerHTML = `
        <div class="subject-header" onclick="toggleSubject('${subject}')">
          <h2>${subject}</h2>
          <div class="subject-actions">
            <button class="reset-btn" onclick="resetSubject('${subject}'); event.stopPropagation();">Reset</button>
            <div class="subject-toggle">‚ñº</div>
          </div>
        </div>
        <div class="subject-content">
          <table>
            <thead>
              <tr>
                <th>Chapter</th>
                <th>Lecture</th>
                <th>Revision</th>
                <th colspan="6" class="pyq-header">Previous Year Questions</th>
                <th>Formula</th>
              </tr>
              <tr>
                <th></th>
                <th></th>
                <th></th>
                <th class="pyq-label">'21</th>
                <th class="pyq-label">'22</th>
                <th class="pyq-label">'23</th>
                <th class="pyq-label">'24</th>
                <th class="pyq-label">'25</th>
                <th class="pyq-label">'26</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${syllabus[subject].map(ch => renderRow(subject, ch)).join("")}
            </tbody>
          </table>
        </div>
      `;
      return div;
    }

    function renderRow(subject, chapter) {
      if (!data[subject]) data[subject] = {};
      if (!data[subject][chapter]) {
        data[subject][chapter] = {};
        COLUMNS.forEach(c => data[subject][chapter][c] = false);
      }
      return `
        <tr>
          <td>${chapter}</td>
          ${COLUMNS.map(c =>
            `<td><input type="checkbox"
              ${data[subject][chapter][c] ? "checked" : ""}
              onchange="toggle('${subject}','${chapter}','${c}')"></td>`
          ).join("")}
        </tr>
      `;
    }

    /* --------- DATA --------- */
    async function toggle(subject, chapter, col) {
      data[subject][chapter][col] = !data[subject][chapter][col];
      drawGraph();
      await saveToCloud();
    }

    async function resetSubject(subject) {
      if (confirm(`Reset all progress for ${subject}? This cannot be undone.`)) {
        delete data[subject];
        await saveToCloud();
        init();
      }
    }

    function toggleSubject(subject) {
      const el = document.querySelector(`.subject[data-subject="${subject}"]`);
      const isExpanded = el.getAttribute("data-expanded") === "true";
      el.setAttribute("data-expanded", String(!isExpanded));
      localStorage.setItem(`subject-${subject}-expanded`, String(!isExpanded));
    }

    /* --------- GLOBAL RESET --------- */
    document.getElementById("globalReset").addEventListener("click", async function () {
      if (confirm("Reset ALL progress? This will clear everything from the cloud.")) {
        data = {};
        await saveToCloud();
        init();
      }
    });

    /* --------- MANUAL SYNC --------- */
    document.getElementById("syncBtn").addEventListener("click", async function () {
      await saveToCloud();
    });

    /* --------- THEME TOGGLE --------- */
    document.getElementById("themeToggle").addEventListener("click", function () {
      const current = document.body.getAttribute("data-theme");
      const newTheme = current === "dark" ? "light" : "dark";
      document.body.setAttribute("data-theme", newTheme);
      updateThemeButton(newTheme);
      localStorage.setItem("theme", newTheme);
      drawGraph();
    });

    /* --------- PROGRESS --------- */
    function subjectProgress(subject) {
      let total = 0, done = 0;
      syllabus[subject].forEach(ch => {
        COLUMNS.forEach(c => {
          total++;
          if (data[subject]?.[ch]?.[c]) done++;
        });
      });
      return total > 0 ? Math.round((done / total) * 100) : 0;
    }

    function drawGraph() {
      const canvas = document.getElementById("progressChart");
      const container = canvas.parentElement;
      const ctx = canvas.getContext("2d");
      
      const width = container.offsetWidth - 40;
      const height = 200;
      
      const dpr = window.devicePixelRatio || 1;
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      ctx.scale(dpr, dpr);

      ctx.clearRect(0, 0, width, height);

      const subjects = Object.keys(syllabus);
      const barWidth = 60;
      const spacing = Math.max(20, (width - subjects.length * barWidth) / (subjects.length + 1));
      const maxBarHeight = 140;
      
      const isDark = document.body.getAttribute("data-theme") === "dark";
      const textColor = isDark ? "#ffffff" : "#1a202c";
      const percentColor = isDark ? "#00f2fe" : "#4facfe";

      subjects.forEach((s, i) => {
        const x = spacing + i * (barWidth + spacing);
        const percent = subjectProgress(s);
        const height = (percent / 100) * maxBarHeight;
        
        const gradient = ctx.createLinearGradient(x, 180 - height, x, 180);
        gradient.addColorStop(0, "#4facfe");
        gradient.addColorStop(1, "#00f2fe");
        ctx.fillStyle = gradient;
        ctx.fillRect(x, 180 - height, barWidth, height);

        ctx.fillStyle = textColor;
        ctx.font = "bold 12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(s, x + barWidth / 2, 195);
        
        ctx.fillStyle = percentColor;
        ctx.font = "bold 14px Arial";
        if (height > 15) {
          ctx.fillText(`${percent}%`, x + barWidth / 2, 175 - height);
        } else {
          ctx.fillText(`${percent}%`, x + barWidth / 2, 165);
        }
      });
    }

    // Init
    window.addEventListener("load", init);

    // Resize
    let resizeTimer;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(drawGraph, 250);
    });

    // Auto-save on page unload
    window.addEventListener("beforeunload", () => {
      saveToCloud();
    });

    // Set Telegram theme colors
    if (tg.colorScheme === 'dark') {
      document.body.setAttribute("data-theme", "dark");
      updateThemeButton("dark");
    } else {
      document.body.setAttribute("data-theme", "light");
      updateThemeButton("light");
    }
  </script>
</body>
</html>
